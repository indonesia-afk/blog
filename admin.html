<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>news.t-o-m.my.id — Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f7f7fb;--card:#ffffff;--text:#222;--muted:#666;--accent:#f7b500;--accent2:#ffd84d;}
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);color:var(--text);font-family:'Poppins',sans-serif;}
    header{position:sticky;top:0;background:rgba(255,255,255,.8);backdrop-filter:blur(12px);padding:1rem 1.2rem;border-bottom:1px solid #eee;}
    h1{margin:0;font-size:1.1rem;}
    main{max-width:980px;margin:1rem auto;padding:0 1rem;}
    .card{background:var(--card);border-radius:16px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:1rem;margin-bottom:1rem;}
    label{display:block;margin:.25rem 0 .2rem;font-weight:500;}
    input,select,textarea{width:100%;padding:.6rem .75rem;border:1px solid #ddd;border-radius:16px;font-family:inherit;outline:none;}
    textarea{min-height:120px;resize:vertical;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
    .btn{display:inline-block;background:linear-gradient(135deg,var(--accent2),var(--accent));color:#000;border:none;padding:.6rem 1.1rem;border-radius:20px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:transform .2s;}
    .btn:hover{transform:scale(1.03);}
    .btn.secondary{background:#efefef;}
    .right{display:flex;gap:.5rem;justify-content:flex-end;flex-wrap:wrap;}
    table{width:100%;border-collapse:collapse;font-size:.9rem;}
    th,td{padding:.6rem;border-bottom:1px solid #eee;vertical-align:top;}
    th{font-weight:600;text-align:left;color:#444;}
    .muted{color:var(--muted);font-size:.85rem;}
    .tag{display:inline-block;padding:.2rem .5rem;background:#f2f2f2;border-radius:999px;font-size:.8rem;}
    .danger{color:#b00020;cursor:pointer;}
    .hidden{display:none;}
    .mt{margin-top:.6rem;}
    #formMsg a{color:var(--accent);font-weight:500;text-decoration:none;}

    /* LOGIN */
    #loginCard{max-width:400px;margin:15vh auto;text-align:center;padding:2rem;}
    #loginCard input{text-align:center;font-size:1rem;}
    #loginBtn{margin-top:1rem;width:100%;}

    /* PREVIEW GAMBAR */
    #oldImages{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem;}
    .thumb-wrap{position:relative;width:70px;height:70px;}
    .thumb-wrap img{width:100%;height:100%;object-fit:cover;border-radius:10px;border:1px solid #ddd;}
    .thumb-wrap button.remove{position:absolute;top:2px;right:2px;width:20px;height:20px;border:none;border-radius:50%;background:rgba(0,0,0,.6);color:#fff;cursor:pointer;font-size:.8rem;line-height:20px;}

    /* LIST LINK DOKUMEN */
    #linkList .link-row{display:flex;gap:.5rem;margin-bottom:.5rem;}
    #linkList input{flex:1;}
    #linkList button.remove-link{border:none;background:#eee;padding:.4rem .6rem;border-radius:10px;cursor:pointer;}
    #addLinkBtn{margin-top:.5rem;background:#eee;border:none;padding:.4rem .8rem;border-radius:12px;cursor:pointer;font-size:.9rem;}

    /* FILTER & SORT AREA (baru, tetap ringan & senada) */
    #searchSortRow{text-align:center;margin-top:.8rem;}
    #searchSortRow input{max-width:420px;}
    #searchSortRow select{display:inline-block;width:auto;min-width:140px;margin:.35rem .4rem;padding:.5rem .75rem;border-radius:16px;border:1px solid #ddd;}

    /* RESPONSIVE */
    @media(max-width:600px){
      .row{grid-template-columns:1fr;}
      #loginCard{margin:20vh 1rem;}
      header h1{font-size:1rem;}
      table, thead, tbody, th, td, tr {display:block;}
      thead{display:none;}
      tr{margin-bottom:1rem;border:1px solid #eee;border-radius:12px;padding:.5rem;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05);}
      td{border:none;padding:.3rem 0;}
      td::before{content:attr(data-label);font-weight:600;display:block;color:#444;margin-bottom:.2rem;}
      .right{justify-content:center;}
      #searchSortRow input{width:100%;max-width:100%;}
      #searchSortRow select{width:46%;}
    }

    /* LOADING + MODAL */
    #loadingOverlay{position:fixed;inset:0;background:rgba(255,255,255,0.7);display:none;justify-content:center;align-items:center;z-index:3000;}
    .spinner{width:50px;height:50px;border:4px solid #ddd;border-top:4px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    #customModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:4000;}
    .modal-box{background:var(--card);color:var(--text);padding:1.5rem;border-radius:16px;max-width:300px;text-align:center;box-shadow:0 6px 18px rgba(0,0,0,.2);animation:fadeIn .3s ease;}
    @keyframes fadeIn{from{opacity:0;transform:scale(.9);}to{opacity:1;transform:scale(1);}}
    .modal-box button{margin-top:1rem;}
  </style>
</head>
<body>
  <header><h1>Admin News</h1></header>
  <main>
    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <h3>Login Admin</h3>
      <form id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button id="loginBtn" type="submit" class="btn">Masuk</button>
      </form>
      <div id="loginMsg" class="muted mt"></div>
    </div>

    <!-- FORM KONTEN -->
    <div id="formCard" class="card hidden">
      <h3 id="formTitle">Tambah Konten</h3>
      <div class="row">
        <div>
          <label>Judul</label>
          <input type="text" id="fJudul" placeholder="Judul berita/pengumuman/peraturan">
        </div>
        <div>
          <label>Kategori</label>
          <select id="fKategori">
            <option>Berita</option>
            <option>Pengumuman</option>
            <option>Peraturan</option>
          </select>
        </div>
      </div>

      <label>Isi Konten</label>
      <textarea id="fIsi" placeholder="Tulis isi lengkap di sini..."></textarea>

      <!-- UPLOAD GAMBAR ATAU LINK DOKUMEN -->
      <div class="row" id="uploadRow">
        <div id="uploadContainer">
          <label>Upload Gambar</label>
          <input type="file" id="fFile" accept="image/*" multiple>
          <div class="muted">Anda bisa pilih lebih dari 1 gambar.</div>
          <div id="oldImages"></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Status</label>
          <select id="fStatus"><option>Aktif</option><option>Arsip</option></select>
        </div>
        <div>
          <label>Slug (opsional)</label>
          <input type="text" id="fSlug" placeholder="contoh-judul-berita">
        </div>
      </div>

      <div class="right mt">
        <button class="btn secondary" id="resetBtn">Bersihkan</button>
        <button class="btn" id="saveBtn">Simpan</button>
        <button class="btn secondary" id="logoutBtn">Logout</button>
      </div>
      <div id="formMsg" class="muted mt"></div>
    </div>

    <!-- LIST KONTEN -->
    <div id="listCard" class="card hidden">
      <h3 style="text-align:center;">Daftar Konten</h3>

      <!-- Search + Filter + Sort (center) -->
      <div id="searchSortRow">
        <input id="searchAdmin" type="text" placeholder="Cari judul atau isi konten..." />
        <div>
          <select id="filterKategori">
            <option value="">Semua Kategori</option>
            <option>Berita</option>
            <option>Pengumuman</option>
            <option>Peraturan</option>
          </select>
          <select id="sortSelect">
            <option value="terbaru">Urutkan: Terbaru</option>
            <option value="terlama">Urutkan: Terlama</option>
            <option value="aktif">Status: Aktif</option>
            <option value="arsip">Status: Arsip</option>
            <option value="draft">Status: Draft</option>
          </select>
        </div>
      </div>

      <div class="muted mt">Klik "Edit" untuk memuat data ke form. "Arsipkan" untuk menyembunyikan dari publik. "Hapus" untuk menghapus permanen.</div>

      <table>
        <thead><tr><th>Judul</th><th>Kategori</th><th>Tanggal</th><th>Status</th><th>Media</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <!-- LOADING + MODAL -->
  <div id="loadingOverlay"><div class="spinner"></div></div>
  <div id="customModal"><div class="modal-box"><p id="modalMessage">Pesan notifikasi</p><button onclick="closeModal()" class="btn">OK</button></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, getDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyDEGklPNtv-LvKzSW0d3QZRo5DMLr1nY-Y",authDomain:"portal-berita-firebase.firebaseapp.com",projectId:"portal-berita-firebase",storageBucket:"portal-berita-firebase.appspot.com",messagingSenderId:"598254123187",appId:"1:598254123187:web:9418bcbe0a00dda3c3d8c6"};
const app=initializeApp(firebaseConfig);const auth=getAuth(app);const db=getFirestore(app);

const loginCard=document.getElementById("loginCard");
const formCard=document.getElementById("formCard");
const listCard=document.getElementById("listCard");
const tbody=document.getElementById("tbody");
const uploadContainer=document.getElementById("uploadContainer");
const oldImages=document.getElementById("oldImages");
const searchAdmin=document.getElementById("searchAdmin");
const sortSelect=document.getElementById("sortSelect");
const filterKategori=document.getElementById("filterKategori");

function slugify(str){
  return (str||"")
    .toString()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"") // hilangkan diakritik
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g,"") // buang karakter non-alfanumerik
    .trim()
    .replace(/\s+/g,"-")         // spasi => dash
    .replace(/-+/g,"-");         // dash ganda => tunggal
}

const fJudulEl = document.getElementById("fJudul");
const fSlugEl  = document.getElementById("fSlug");

if (fJudulEl && fSlugEl) {
  fJudulEl.addEventListener("input", () => {
    // hanya auto-isi kalau slug masih kosong (admin tetap bisa override manual)
    if (!fSlugEl.value.trim()) {
      fSlugEl.value = slugify(fJudulEl.value);
    }
  });
}
    
let EDIT_ID=null;let currentImages=[];let removedImages=new Set();
let allDocs=[]; // cache untuk data Firestore

function showLoading(on=true){document.getElementById("loadingOverlay").style.display=on?"flex":"none";}
window.showModal=(msg)=>{document.getElementById("modalMessage").textContent=msg;document.getElementById("customModal").style.display="flex";}
window.closeModal=()=>{document.getElementById("customModal").style.display="none";}

/* === LOGIN === */
document.getElementById("loginForm").addEventListener("submit",async(e)=>{
  e.preventDefault();
  const email=document.getElementById("loginEmail").value;
  const pw=document.getElementById("loginPassword").value;
  try{await signInWithEmailAndPassword(auth,email,pw);}catch{document.getElementById("loginMsg").textContent="Login gagal";}
});

onAuthStateChanged(auth,(user)=>{
  if(user){loginCard.classList.add("hidden");formCard.classList.remove("hidden");listCard.classList.remove("hidden");reloadList();}
  else{loginCard.classList.remove("hidden");formCard.classList.add("hidden");listCard.classList.add("hidden");}
});

document.getElementById("logoutBtn").onclick=()=>signOut(auth);
document.getElementById("resetBtn").onclick=()=>resetForm();
document.getElementById("saveBtn").onclick=()=>submitForm();
filterKategori.addEventListener("change",()=>reloadList());
sortSelect.addEventListener("change",applySortFilter);
searchAdmin.addEventListener("keyup",applyAdminSearchFilter);

/* === GANTI FORM SESUAI KATEGORI (Peraturan = link; lainnya = gambar) === */
document.getElementById("fKategori").addEventListener("change",()=>{
  const cat=document.getElementById("fKategori").value;
  uploadContainer.innerHTML="";
  if(cat==="Peraturan"){
    uploadContainer.innerHTML=`<label>Tambahkan Link Dokumen</label>
      <div id="linkList"></div>
      <button id="addLinkBtn" type="button">+ Tambah Link</button>
      <div class="muted">Masukkan nama dan link dokumen (bisa lebih dari satu).</div>
      <div class="muted" style="margin-top:.4rem;">⚠️ Pastikan file berasal dari Google Drive dengan pengaturan <b>"Anyone with the link"</b> sebagai Viewer agar dapat diakses publik.</div>`;
    const btn=document.getElementById("addLinkBtn"); if(btn) btn.addEventListener("click",()=>addLinkRow());
  }else{
    uploadContainer.innerHTML=`<label>Upload Gambar</label>
      <input type="file" id="fFile" accept="image/*" multiple>
      <div class="muted">Anda bisa pilih lebih dari 1 gambar.</div>
      <div id="oldImages"></div>`;
    // Saat kategori kembali ke Berita/Pengumuman, render ulang preview gambar lama
    renderOldImages();
  }
});

/* === TAMBAH LINK ROW === */
function addLinkRow(name="",url=""){
  if(typeof name==="object"){name="";url="";}
  const list=document.getElementById("linkList");
  if(!list) return;
  const row=document.createElement("div");
  row.className="link-row";
  row.innerHTML=`
    <input type="text" placeholder="Nama Dokumen" value="${name}">
    <input type="text" placeholder="Link Dokumen" value="${url}">
    <button type="button" class="remove-link">×</button>`;
  row.querySelector(".remove-link").onclick=()=>row.remove();
  list.appendChild(row);
}

/* === LIST FIRESTORE === */
async function reloadList(){
  showLoading(true);
  let q=collection(db,"posts");
  const cat=filterKategori.value;
  if(cat) q=query(collection(db,"posts"),where("category","==",cat));
  const snap=await getDocs(q);

  allDocs=[];
  snap.forEach(d=>allDocs.push({id:d.id,...d.data()}));
  showLoading(false);

  // Terapkan urutan default "Terbaru" saat load
  sortSelect.value="terbaru";
  applySortFilter(); // akan renderTable() di dalamnya
}

/* === RENDER TABLE === */
function renderTable(data){
  tbody.innerHTML="";
  data.forEach(d=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td data-label="Judul"><strong>${d.title||""}</strong>
    <div class="muted">${d.slug||""}</div>
    <span class="hidden-content" style="display:none;">${(d.content||"").toLowerCase()}</span>
    <div class="mt"><a href="#" onclick="editRow('${d.id}');return false;">Edit</a> | 
    <a class="danger" href="#" onclick="arsipkan('${d.id}');return false;">Arsipkan</a> | 
    <a class="danger" href="#" onclick="hapus('${d.id}');return false;">Hapus</a></div></td>
    <td data-label="Kategori">${d.category||""}</td>
    <td data-label="Tanggal">${formatTanggal(d.createdAt)}</td>
    <td data-label="Status"><span class="tag">${d.status||""}</span></td>
    <td data-label="Media">${d.category==="Peraturan"?(d.links?.length||0)+" dokumen":(d.images&&d.images.length>0?`<a href="${d.images[0]}" target="_blank">Lihat</a>`:"-")}</td>`;
    tbody.appendChild(tr);
  });
  applyAdminSearchFilter();
}

function formatTanggal(ts){
  try{
    if(!ts) return "";
    if(typeof ts.toDate==="function") return ts.toDate().toLocaleDateString("id-ID");
    const d=new Date(ts);return isNaN(d)?"" : d.toLocaleDateString("id-ID");
  }catch{return "";}
}

/* === SORT & FILTER (client-side di atas allDocs) === */
function getSeconds(ts){
  if(!ts) return 0;
  if(typeof ts.seconds==="number") return ts.seconds;
  if(typeof ts.toDate==="function") return Math.floor(ts.toDate().getTime()/1000);
  const d=new Date(ts);return isNaN(d)?0:Math.floor(d.getTime()/1000);
}

function applySortFilter(){
  let data=[...allDocs];
  const val=sortSelect.value;

  if(val==="terbaru"){
    data.sort((a,b)=>getSeconds(b.createdAt)-getSeconds(a.createdAt));
  }else if(val==="terlama"){
    data.sort((a,b)=>getSeconds(a.createdAt)-getSeconds(b.createdAt));
  }else if(["aktif","arsip","draft"].includes(val)){
    data=data.filter(d=>(d.status||"").toLowerCase()===val);
  }
  renderTable(data);
}

/* === SEARCH (DOM filter di hasil render) === */
function applyAdminSearchFilter(){
  const q=(searchAdmin.value||"").trim().toLowerCase();
  const rows=[...document.querySelectorAll("#tbody tr")];
  if(!q){rows.forEach(r=>r.style.display="");return;}
  rows.forEach(r=>{
    const judulCell=r.querySelector("td[data-label='Judul']");
    const titleText=(judulCell?.querySelector("strong")?.textContent||"").toLowerCase();
    const contentText=(judulCell?.querySelector(".hidden-content")?.textContent||"").toLowerCase();
    r.style.display=(titleText.includes(q)||contentText.includes(q))?"":"none";
  });
}

/* === EDIT === */
window.editRow=async(id)=>{
  showLoading(true);
  const snap=await getDoc(doc(db,"posts",id));
  showLoading(false);
  if(!snap.exists())return;
  const d=snap.data();EDIT_ID=id;

  document.getElementById("formTitle").textContent="Edit Konten";
  document.getElementById("fJudul").value=d.title||"";
  document.getElementById("fKategori").value=d.category||"Berita";
  document.getElementById("fIsi").value=d.content||"";
  document.getElementById("fStatus").value=d.status||"Aktif";
  document.getElementById("fSlug").value=d.slug||"";

  // Render ulang bagian upload/link sesuai kategori
  document.getElementById("fKategori").dispatchEvent(new Event("change"));

  if(d.category==="Peraturan" && Array.isArray(d.links)){
    // Peraturan: tetap seperti semula
    d.links.forEach(l=>addLinkRow(l.name||"",l.url||""));
    currentImages=[]; removedImages.clear(); // pastikan kosong
  }else{
    // Berita / Pengumuman: siapkan gambar lama
    currentImages=Array.isArray(d.images)?d.images.slice():[];
    removedImages=new Set();
    renderOldImages(); // tampilkan preview
  }

  window.scrollTo({top:0,behavior:"smooth"});
};

/* === IMAGE PREVIEW (Berita & Pengumuman saja) === */
function renderOldImages(){
  const cat=document.getElementById("fKategori").value;
  const wrap=document.getElementById("oldImages");
  if(!wrap) return;
  wrap.innerHTML="";

  if(cat!=="Berita" && cat!=="Pengumuman") return; // Peraturan: tidak pakai preview gambar lama

  currentImages.forEach(url=>{
    if(removedImages.has(url))return;
    const div=document.createElement("div");
    div.className="thumb-wrap";
    div.innerHTML=`<img src="${url}" alt=""><button class="remove" onclick="removeOldImage('${url}')">×</button>`;
    wrap.appendChild(div);
  });
}

window.removeOldImage=(url)=>{removedImages.add(url);renderOldImages();};

/* === ARSIP & HAPUS === */
window.arsipkan=async(id)=>{await updateDoc(doc(db,"posts",id),{status:"Arsip"});showModal("Konten diarsipkan.");reloadList();}
window.hapus=async(id)=>{await deleteDoc(doc(db,"posts",id));showModal("Konten dihapus.");reloadList();}

/* === RESET FORM === */
function resetForm(){
  EDIT_ID=null;
  document.getElementById("formTitle").textContent="Tambah Konten";
  ["fJudul","fIsi","fSlug"].forEach(id=>{
    const el=document.getElementById(id);
    if(el)el.value="";
  });
  document.getElementById("fKategori").value="Berita";
  document.getElementById("fStatus").value="Aktif";
  const fFile=document.getElementById("fFile");
  if(fFile)fFile.value="";
  document.getElementById("formMsg").textContent="";
  currentImages=[];removedImages.clear();
  const wrap=document.getElementById("oldImages"); if(wrap) wrap.innerHTML="";
  document.getElementById("fKategori").dispatchEvent(new Event("change"));
}
    
/* === CEK SLUG UNIK === */
async function isSlugUsed(slug, currentId=null){
  if(!slug) return false; // slug kosong, abaikan
  const q = query(collection(db, "posts"), where("slug", "==", slug));
  const snap = await getDocs(q);
  if(snap.empty) return false;
  // Jika sedang edit, pastikan bukan dokumen yang sama
  return snap.docs.some(docSnap => docSnap.id !== currentId);
}

/* === SIMPAN DATA === */
async function submitForm(){
  const title=document.getElementById("fJudul").value.trim();
  const category=document.getElementById("fKategori").value;
  const content=document.getElementById("fIsi").value.trim();
  const status=document.getElementById("fStatus").value;
  const slug=document.getElementById("fSlug").value.trim();
  // 🔍 Cek slug unik sebelum menyimpan
  if (slug) {
    const used = await isSlugUsed(slug, EDIT_ID);
    if (used) {
      showModal("Slug '"+slug+"' sudah dipakai oleh konten lain. Gunakan slug berbeda.");
      return; // hentikan proses simpan
    }
  }

  let payload={title,category,content,status,slug,author:auth.currentUser.email};


  if(category==="Peraturan"){
    // Tetap: mengelola link dokumen
    const rows=document.querySelectorAll("#linkList .link-row");
    const links=[];
    rows.forEach(r=>{
      const name=r.children[0].value.trim();
      const url=r.children[1].value.trim();
      if(url)links.push({name,url});
    });
    payload.links=links;
  }else{
    // Berita & Pengumuman: gabungkan gambar lama (kecuali yang dihapus) + gambar baru
    const fileInput=document.getElementById("fFile");
    const files=fileInput?fileInput.files:[];
    const keptOld=currentImages.filter(u=>!removedImages.has(u));
    const imageUrls=[...keptOld];

    if(files.length>0){
      showLoading(true);
      for(const file of files){
        const formData=new FormData();
        formData.append("file",file);
        formData.append("upload_preset","portal-firebase");
        const res=await fetch("https://api.cloudinary.com/v1_1/dfojor5pr/image/upload",{method:"POST",body:formData});
        const data=await res.json();
        if(data.secure_url) imageUrls.push(data.secure_url);
      }
      showLoading(false);
    }
    payload.images=imageUrls;
  }

try{
  if(EDIT_ID){
    payload.updatedAt = serverTimestamp();           // ← tandai waktu edit/publish ulang
    await updateDoc(doc(db,"posts",EDIT_ID),payload);
  }else{
    payload.createdAt = serverTimestamp();           // ← hanya saat buat baru
    await addDoc(collection(db,"posts"),payload);
  }
  showModal("Konten berhasil disimpan.");resetForm();reloadList();
}catch(err){showModal("Gagal menyimpan: "+err.message);}

}
</script>
</body>
</html>
